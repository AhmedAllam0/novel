{
  "name": "ğŸ¤–ğŸ’¬ Bot Find Links to Download Books",
  "nodes": [
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('sessionData').item.json.message || $('userInput').item.json.message.text }}",
        "options": {
          "systemMessage": "=\"ğŸ¤– Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ Ù…ØªØ®ØµØµ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙƒØªØ¨ ÙˆØ§Ù„Ø±ÙˆØ§ÙŠØ§Øª Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ğŸ“š\n\nğŸ¯ Ø§Ù„Ù…Ù‡Ø§Ù…:\n1. Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø±ÙˆØ§Ø¨Ø· ØªØ­Ù…ÙŠÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… find_book_download_link\n2. ØªÙ‚Ø¯ÙŠÙ… Ù…Ù„Ø®ØµØ§Øª ÙˆÙ…Ø¹Ù„ÙˆÙ…Ø§Øª\n3. Ø§Ù‚ØªØ±Ø§Ø­ Ø¨Ø¯Ø§Ø¦Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©\n\nâœ… Ù…ØªÙ‰ ØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø¯Ø§Ø©:\n- Ø¹Ù†Ø¯ Ø£ÙŠ Ø·Ù„Ø¨ ÙŠØ­ØªÙˆÙŠ: \\\"ØªØ­Ù…ÙŠÙ„\\\"ØŒ \\\"Ø±Ø§Ø¨Ø·\\\"ØŒ \\\"PDF\\\"ØŒ \\\"ÙƒØªØ§Ø¨\\\"\n- Ø¹Ù†Ø¯ Ø°ÙƒØ± Ø§Ø³Ù… ÙƒØªØ§Ø¨ Ø£Ùˆ Ø±ÙˆØ§ÙŠØ© Ù…Ø­Ø¯Ø¯Ø©\n\nğŸ“ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø±Ø¯ (Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹):\n\nğŸ“š <b>[Ø§Ø³Ù… Ø§Ù„ÙƒØªØ§Ø¨]</b>\n\nğŸ” <b>Ù†Ø¨Ø°Ø©:</b>\n[Ù…Ù„Ø®Øµ Ù…Ø®ØªØµØ± 2-3 Ø£Ø³Ø·Ø± ÙÙ‚Ø·]\n\nğŸ¯ <b>Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØªØ­Ù…ÙŠÙ„:</b>\n\n1ï¸âƒ£ <b>[Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹]</b>\nğŸ”— <a href=\\\"[URL]\\\">[Ø§Ù„Ø¹Ù†ÙˆØ§Ù†]</a>\n[Ø¥ÙŠÙ…ÙˆØ¬ÙŠ ğŸ“„ Ù„Ùˆ PDF]\n\n2ï¸âƒ£ ...\n\nğŸ’¡ <i>Ù†ØµÙŠØ­Ø©: Ø¬Ø±Ø¨ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø£ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹!</i>\n\nâš ï¸ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ (ØµØ§Ø±Ù…Ø© Ø¬Ø¯Ø§Ù‹):\n\n1. âœ… Ø§Ø³ØªØ®Ø¯Ù… HTML ÙÙ‚Ø·:\n   - <b>Ù†Øµ Ø¹Ø±ÙŠØ¶</b> (Ù„ÙŠØ³ **Ù†Øµ**)\n   - <i>Ù†Øµ Ù…Ø§Ø¦Ù„</i> (Ù„ÙŠØ³ *Ù†Øµ*)\n   - <a href=\"Ø±Ø§Ø¨Ø·\">Ù†Øµ</a>\n\n2. âŒ Ù…Ù…Ù†ÙˆØ¹ Ø§Ø³ØªØ®Ø¯Ø§Ù… Markdown:\n   - Ù„Ø§ ØªØ³ØªØ®Ø¯Ù… **Ù†Øµ** Ø£Ø¨Ø¯Ø§Ù‹\n   - Ù„Ø§ ØªØ³ØªØ®Ø¯Ù… *Ù†Øµ* Ø£Ø¨Ø¯Ø§Ù‹\n   - Ù„Ø§ ØªØ³ØªØ®Ø¯Ù… __Ù†Øµ__ Ø£Ø¨Ø¯Ø§Ù‹\n\n3. âœ… Ø£Ù…Ø«Ù„Ø© ØµØ­ÙŠØ­Ø©:\n   âœ“ <b>Ø±ÙˆØ§ÙŠØ© 1984</b>\n   âœ“ ÙÙŠ <b>Ø£ÙˆÙ‚ÙŠØ§Ù†ÙŠØ§</b>\n   âœ“ <b>\"Ø§Ù„Ø­Ø²Ø¨ Ø§Ù„ÙƒØ¨ÙŠØ±\"</b>\n\n4. âŒ Ø£Ù…Ø«Ù„Ø© Ø®Ø§Ø·Ø¦Ø©:\n   âœ— **Ø±ÙˆØ§ÙŠØ© 1984**\n   âœ— ÙÙŠ **Ø£ÙˆÙ‚ÙŠØ§Ù†ÙŠØ§**\n   âœ— **\"Ø§Ù„Ø­Ø²Ø¨ Ø§Ù„ÙƒØ¨ÙŠØ±\"**\n\nğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {{ $('sessionData').item.json.firstName }}\nğŸ“© Ø§Ù„Ø±Ø³Ø§Ù„Ø©: {{ $('sessionData').item.json.message }}\n\nğŸ’¬ Ø¢Ø®Ø± 3 Ù…Ø­Ø§Ø¯Ø«Ø§Øª:\n{{ $('latestContext').item.json.messages || 'Ù„Ø§ ØªÙˆØ¬Ø¯' }}\n\nğŸš€ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø±Ø¯:\"\n",
          "returnIntermediateSteps": true
        }
      },
      "id": "115c1837-ee9a-4cb3-90e2-4a0baa8d788a",
      "name": "ChatCore",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "position": [
        1088,
        -64
      ],
      "typeVersion": 1.9,
      "alwaysOutputData": false,
      "retryOnFail": false
    },
    {
      "parameters": {
        "chatId": "={{ $('sessionData').item.json.sessionId }}",
        "text": "={{ $('Delay and Pass Data').first().json.text }}",
        "replyMarkup": "=={{ $('Delay and Pass Data').first().json.reply_markup }}",
        "forceReply": {},
        "replyKeyboardOptions": {},
        "replyKeyboardRemove": {},
        "additionalFields": {
          "disable_web_page_preview": true,
          "parse_mode": "HTML"
        }
      },
      "id": "f0d97bc2-b2ec-48c7-a3d3-22fcfc0406fd",
      "name": "sendTextMessage",
      "type": "n8n-nodes-base.telegram",
      "position": [
        2384,
        -64
      ],
      "webhookId": "9e1db2b1-3bf0-460a-a3a4-cf78d57f2353",
      "typeVersion": 1,
      "credentials": {
        "telegramApi": {
          "id": "xnP9fkvEEq9ew47g",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "keepOnlySet": true,
        "values": {
          "string": [
            {
              "name": "message",
              "value": "={{ $('userInput').item.json.message.text }}"
            },
            {
              "name": "sessionId",
              "value": "={{ $('userInput').item.json.message.chat.id }}"
            },
            {
              "name": "firstName",
              "value": "={{ $('userInput').item.json.message.from.first_name || 'Ù…Ø³ØªØ®Ø¯Ù…' }}"
            },
            {
              "name": "username",
              "value": "={{ $('userInput').item.json.message.from.username || 'unknown' }}"
            },
            {
              "name": "language",
              "value": "={{ $('userInput').item.json.message.from.language_code || 'ar' }}"
            },
            {
              "name": "chatType",
              "value": "={{ $('userInput').item.json.message.chat.type }}"
            },
            {
              "name": "timestamp",
              "value": "={{ $now.toISO() }}"
            }
          ],
          "number": [
            {
              "name": "messageId",
              "value": "={{ $('userInput').item.json.message.message_id }}"
            }
          ],
          "boolean": [
            {
              "name": "isGroup",
              "value": "={{ $('userInput').item.json.message.chat.type !== 'private' }}"
            }
          ]
        },
        "options": {}
      },
      "id": "666f411b-ed2a-4cb1-9782-64082b75bb99",
      "name": "sessionData",
      "type": "n8n-nodes-base.set",
      "position": [
        224,
        -64
      ],
      "typeVersion": 2,
      "alwaysOutputData": true,
      "retryOnFail": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "options": {
          "groupMessages": true
        }
      },
      "id": "d6eee001-1cd8-4db2-ac27-e098529a6cae",
      "name": "conversationStore",
      "type": "@n8n/n8n-nodes-langchain.memoryManager",
      "position": [
        448,
        -64
      ],
      "typeVersion": 1.1,
      "alwaysOutputData": true,
      "retryOnFail": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('sessionData').item.json.sessionId }}",
        "contextWindowLength": 15
      },
      "id": "be7f06d7-58e9-4920-897e-89a9bf2a4e38",
      "name": "memoryRetriever",
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "position": [
        528,
        160
      ],
      "typeVersion": 1.3
    },
    {
      "parameters": {
        "jsCode": "const allItems = $input.all();\nconst lastItem = allItems[allItems.length - 1];\n\n// Helper functions\nfunction extractFirstLine(text) {\n  if (!text) return \"\";\n  return text.split('\\n')[0].replace(/^Input from user:\\s*/, '');\n}\n\nfunction trimEndNewline(text) {\n  if (!text) return \"\";\n  return text.replace(/\\n+$/, '');\n}\n\n// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ messages\nif (!lastItem || !Array.isArray(lastItem.json.messages)) {\n  return [{ json: { \n    messages: \"\",\n    sessionData: $('sessionData').item.json || {}\n  }}];\n}\n\nconst messages = lastItem.json.messages;\nconst count = messages.length;\n\n// Ù„Ùˆ Ù…ÙÙŠØ´ Ø±Ø³Ø§Ø¦Ù„\nif (count === 0) {\n  return [{ json: { \n    messages: \"\",\n    sessionData: $('sessionData').item.json || {}\n  }}];\n}\n\n// Ø§Ø®ØªÙŠØ§Ø± Ø¢Ø®Ø± 3 Ø±Ø³Ø§Ø¦Ù„ (Ø¨Ø¯Ù„ 1)\nconst selectedMessages = messages.slice(-3);\n\n// Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù†Øµ\nconst combinedMessage = selectedMessages\n  .map((msg, idx) => {\n    const humanMsg = extractFirstLine(msg.human);\n    const aiMsg = trimEndNewline(msg.ai);\n    \n    return `ğŸ’¬ Ù…Ø­Ø§Ø¯Ø«Ø© ${idx + 1}:\nğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${humanMsg}\nğŸ¤– Ø§Ù„Ø¨ÙˆØª: ${aiMsg}`;\n  })\n  .join('\\n\\n---\\n\\n');\n\n// Ø§Ù„Ø±Ø¬ÙˆØ¹ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª + sessionData\nreturn [{ json: { \n  messages: combinedMessage,\n  sessionData: $('sessionData').item.json || {},\n  messageCount: selectedMessages.length\n}}];"
      },
      "id": "13bdcafb-4047-4ba8-a3a9-5f7e9598aefa",
      "name": "latestContext",
      "type": "n8n-nodes-base.code",
      "position": [
        800,
        -64
      ],
      "typeVersion": 2,
      "alwaysOutputData": true,
      "retryOnFail": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "updates": [
          "message"
        ],
        "additionalFields": {}
      },
      "id": "9564213e-bd1d-41f0-b428-ddeb92339213",
      "name": "userInput",
      "type": "n8n-nodes-base.telegramTrigger",
      "position": [
        0,
        -64
      ],
      "webhookId": "4e9f6007-08b0-451c-a0f4-0739a51c6842",
      "typeVersion": 1,
      "alwaysOutputData": true,
      "retryOnFail": true,
      "credentials": {
        "telegramApi": {
          "id": "xnP9fkvEEq9ew47g",
          "name": "Telegram account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('sessionData').item.json.sessionId }}",
        "contextWindowLength": 15
      },
      "id": "9ca1acfa-a216-4a8a-8183-ad51cc7edfa5",
      "name": "conversationMemory",
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "position": [
        1152,
        160
      ],
      "typeVersion": 1.3
    },
    {
      "parameters": {
        "model": "mistral-large-latest",
        "options": {
          "temperature": 0.3,
          "maxRetries": 2,
          "topP": 0.9
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
      "typeVersion": 1,
      "position": [
        1024,
        160
      ],
      "id": "e1834c37-a04c-44dc-a48b-b5dbb059e9f4",
      "name": "Mistral Cloud Chat Model1",
      "credentials": {
        "mistralCloudApi": {
          "id": "8RlFJeQEIK1RW3KX",
          "name": "Mistral Cloud account"
        }
      }
    },
    {
      "parameters": {
        "description": "find download links ",
        "workflowId": {
          "__rl": true,
          "value": "0L23kFKfH7FjLarJ",
          "mode": "list",
          "cachedResultUrl": "/workflow/0L23kFKfH7FjLarJ",
          "cachedResultName": "Firecrawl"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [
            {
              "id": "type",
              "displayName": "type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "input",
              "displayName": "input",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "query",
              "displayName": "query",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "bookName",
              "displayName": "bookName",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "text",
              "displayName": "text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "search",
              "displayName": "search",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        1280,
        160
      ],
      "id": "175b943b-3ec3-4c5c-a563-d687c0020916",
      "name": "find_book_download_link"
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ“± Ù…Ù†Ø³Ù‚ Ø±Ø³Ø§Ø¦Ù„ Telegram - Ù…Ø¹ Ø¥ØµÙ„Ø§Ø­ Markdown\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst inputData = $input.first().json;\n\nconsole.log('ğŸ“¥ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø© Ù…Ù† ChatCore:', JSON.stringify(inputData).substring(0, 500));\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// âœ… chatcore ÙŠØ¹ÙŠØ¯ ÙÙ‚Ø· output Ù†Øµ Ø¹Ø§Ø¯ÙŠ\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nlet responseText = '';\n\n// 1. Ø£ÙˆÙ„Ø§Ù‹: Ù…Ø­Ø§ÙˆÙ„Ø© Ù‚Ø±Ø§Ø¡Ø© output Ù…Ø¨Ø§Ø´Ø±Ø©\nif (inputData.output && typeof inputData.output === 'string') {\n  responseText = inputData.output;\n  console.log('âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… output Ù…Ù† chatcore Ù…Ø¨Ø§Ø´Ø±Ø©');\n}\n// 2. Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯ØŒ Ø¬Ø±Ø¨ text\nelse if (inputData.text && typeof inputData.text === 'string') {\n  responseText = inputData.text;\n  console.log('âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… text Ù…Ù† chatcore');\n}\n// 3. Ø¢Ø®Ø± Ù…Ø­Ø§ÙˆÙ„Ø©: response\nelse if (inputData.response && typeof inputData.response === 'string') {\n  responseText = inputData.response;\n  console.log('âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… response Ù…Ù† chatcore');\n}\n// 4. Ù„Ùˆ Ù…ÙÙŠØ´ Ø£ÙŠ Ø­Ø§Ø¬Ø©\nelse {\n  responseText = 'âŒ Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø¯. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';\n  console.log('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†Øµ ÙÙŠ Ø§Ù„Ø±Ø¯');\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ”§ Ø¥ØµÙ„Ø§Ø­ Markdown â†’ HTML ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconsole.log('ğŸ”§ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚...');\n\n// ØªØ­ÙˆÙŠÙ„ **Ù†Øµ** Ø¥Ù„Ù‰ <b>Ù†Øµ</b>\nresponseText = responseText.replace(/\\*\\*(.+?)\\*\\*/g, '<b>\\$1</b>');\n\n// ØªØ­ÙˆÙŠÙ„ *Ù†Øµ* Ø¥Ù„Ù‰ <i>Ù†Øµ</i> (Ù„ÙƒÙ† Ø¨Ø¹Ø¯ Ù…Ø§ Ø®Ù„ØµÙ†Ø§ Ù…Ù† **)\nresponseText = responseText.replace(/(?<!\\*)\\*(?!\\*)(.+?)(?<!\\*)\\*(?!\\*)/g, '<i>\\$1</i>');\n\n// ØªØ­ÙˆÙŠÙ„ __Ù†Øµ__ Ø¥Ù„Ù‰ <b>Ù†Øµ</b>\nresponseText = responseText.replace(/__(.+?)__/g, '<b>\\$1</b>');\n\n// ØªØ­ÙˆÙŠÙ„ _Ù†Øµ_ Ø¥Ù„Ù‰ <i>Ù†Øµ</i>\nresponseText = responseText.replace(/(?<!_)_(?!_)(.+?)(?<!_)_(?!_)/g, '<i>\\$1</i>');\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø¥Ø¶Ø§ÙÙŠ\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// Ø¥Ø²Ø§Ù„Ø© <web> tags\nresponseText = responseText.replace(/<web>[\\s\\S]*?<\\/web>/gi, '');\n\n// Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ source tags\nresponseText = responseText.replace(/Source $$\\d+$$.*?$/gim, '');\n\n// ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ø§Ù„Ø²Ø§Ø¦Ø¯Ø©\nresponseText = responseText.replace(/\\n{3,}/g, '\\n\\n');\n\nconsole.log('âœ… ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚');\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ“Š Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (Ø¥Ù† ÙˆØ¬Ø¯Øª)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ù† intermediateSteps Ø¥Ø°Ø§ ÙƒØ§Ù† ChatCore ÙŠØ¹ÙŠØ¯Ù‡Ø§\nlet toolResults = [];\nif (inputData.intermediateSteps && Array.isArray(inputData.intermediateSteps)) {\n  for (const step of inputData.intermediateSteps) {\n    if (step.action && step.action.tool === 'find_book_download_link') {\n      try {\n        const observation = JSON.parse(step.observation);\n        if (observation.results && Array.isArray(observation.results)) {\n          toolResults = observation.results;\n          console.log(`âœ… ÙˆØ¬Ø¯Øª ${toolResults.length} Ù†ØªÙŠØ¬Ø© Ù…Ù† Ø§Ù„Ù€ tool`);\n        }\n      } catch (e) {\n        console.log('âš ï¸ Ø®Ø·Ø£ ÙÙŠ parsing tool results');\n      }\n    }\n  }\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ¨ Ø¥Ø¶Ø§ÙØ© footer Ø¬Ù…ÙŠÙ„\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nresponseText += '\\n\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\nğŸ’¬ <i>Ø§ÙƒØªØ¨ Ø§Ø³Ù… ÙƒØªØ§Ø¨ Ø¢Ø®Ø± Ù„Ù„Ø¨Ø­Ø« Ø¹Ù†Ù‡!</i>';\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ“¤ Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù†ØªÙŠØ¬Ø©\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nreturn [{\n  json: {\n    text: responseText,\n    parse_mode: 'HTML',\n    disable_web_page_preview: true,\n    hasResults: toolResults.length > 0,\n    allResults: toolResults  // Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ ÙÙŠ Build Inline Keyboard\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1488,
        -64
      ],
      "id": "6fa7c03d-96cb-42c8-a3db-9e6a05ef1adb",
      "name": "Format Telegram Message"
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ® Ù…Ù†Ø´Ø¦ Ø§Ù„Ø£Ø²Ø±Ø§Ø± - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¨Ø³Ø·Ø©\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst messageData = $input.first().json;\nconst hasResults = messageData.hasResults || false;\nconst results = messageData.allResults || [];\n\nconst keyboard = {\n  inline_keyboard: []\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ”— Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø±ÙˆØ§Ø¨Ø· (Ø¥Ù† ÙˆØ¬Ø¯Øª)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nif (hasResults && results.length > 0) {\n  // Ø£ÙˆÙ„ 3 Ø±ÙˆØ§Ø¨Ø· ÙÙŠ ØµÙ ÙˆØ§Ø­Ø¯\n  const topResults = results.slice(0, 3);\n  const row = [];\n  \n  topResults.forEach((result, idx) => {\n    const emoji = ['1ï¸âƒ£', '2ï¸âƒ£', '3ï¸âƒ£'][idx];\n    const siteName = (result.site || result.domain || 'Ù…ÙˆÙ‚Ø¹')\n      .replace(/ğŸ“š|ğŸ“–|ğŸŒ|â­|ğŸ›ï¸/g, '')\n      .trim()\n      .substring(0, 12);\n    \n    row.push({\n      text: `${emoji} ${siteName}`,\n      url: result.url\n    });\n  });\n  \n  if (row.length > 0) {\n    keyboard.inline_keyboard.push(row);\n  }\n  \n  // Ù„Ùˆ ÙÙŠÙ‡ Ø±ÙˆØ§Ø¨Ø· Ø£ÙƒØªØ± (4 Ùˆ 5)\n  if (results.length > 3) {\n    const row2 = [];\n    const moreResults = results.slice(3, 5);\n    \n    moreResults.forEach((result, idx) => {\n      const emoji = ['4ï¸âƒ£', '5ï¸âƒ£'][idx];\n      const siteName = (result.site || result.domain || 'Ù…ÙˆÙ‚Ø¹')\n        .replace(/ğŸ“š|ğŸ“–|ğŸŒ|â­|ğŸ›ï¸/g, '')\n        .trim()\n        .substring(0, 12);\n      \n      row2.push({\n        text: `${emoji} ${siteName}`,\n        url: result.url\n      });\n    });\n    \n    if (row2.length > 0) {\n      keyboard.inline_keyboard.push(row2);\n    }\n  }\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ¬ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© (Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù…ÙˆØ¬ÙˆØ¯Ø©)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nkeyboard.inline_keyboard.push([\n  {\n    text: 'ğŸ” Ø¨Ø­Ø« Ø¹Ù† ÙƒØªØ§Ø¨ Ø¢Ø®Ø±',\n    callback_data: 'new_search'\n  }\n]);\n\nkeyboard.inline_keyboard.push([\n  {\n    text: 'â­ ÙƒØªØ¨ Ù…Ø´Ø§Ø¨Ù‡Ø©',\n    callback_data: 'similar_books'\n  },\n  {\n    text: 'ğŸ“š Ø§Ù„Ø£ÙƒØ«Ø± Ø´Ø¹Ø¨ÙŠØ©',\n    callback_data: 'popular_books'\n  }\n]);\n\nkeyboard.inline_keyboard.push([\n  {\n    text: 'ğŸ“¤ Ø´Ø§Ø±Ùƒ Ø§Ù„Ø¨ÙˆØª Ù…Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ',\n    switch_inline_query: 'Ø¬Ø±Ø¨ Ø¨ÙˆØª ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØªØ¨ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ! ğŸ“š'\n  }\n]);\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ“¤ Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù†ØªÙŠØ¬Ø©\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nreturn [{\n  json: {\n    text: messageData.text,\n    parse_mode: 'HTML',\n    reply_markup: keyboard,\n    disable_web_page_preview: true\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1712,
        -64
      ],
      "id": "9287af72-6814-4b5a-8fe9-e01acbc2ae2a",
      "name": "Build Inline Keyboard"
    },
    {
      "parameters": {
        "operation": "sendChatAction",
        "chatId": "={{ $('sessionData').item.json.sessionId }}"
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2160,
        -64
      ],
      "id": "c6a2c175-b1f5-41ea-ad84-c6dccc65fa91",
      "name": "Send a chat action",
      "webhookId": "1cadd5a1-092e-44c5-9b7a-4eab25a3bb6b",
      "credentials": {
        "telegramApi": {
          "id": "xnP9fkvEEq9ew47g",
          "name": "Telegram account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// â±ï¸ ØªØ£Ø®ÙŠØ± Ø§Ø­ØªØ±Ø§ÙÙŠ Ù…Ø¹ ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// ğŸ“¦ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Build Inline Keyboard\nconst buildKeyboardNode = $('Build Inline Keyboard');\nconst keyboardData = buildKeyboardNode.first().json;\n\nconsole.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\nconsole.log('ğŸ” Debug Info:');\nconsole.log('text length:', keyboardData.text?.length || 0);\nconsole.log('reply_markup exists:', !!keyboardData.reply_markup);\nconsole.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\n\n// Ø§Ù„Ù…Ø±Ø§Ø­Ù„\nconst stages = [\n  'ğŸ” Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1/4: Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...',\n  'ğŸ“Š Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2/4: ØªØ­Ù„ÙŠÙ„ ÙˆØªØ±ØªÙŠØ¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬...',\n  'ğŸ¨ Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3/4: ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø±...',\n  'âœ¨ Ø§Ù„Ù…Ø±Ø­Ù„Ø© 4/4: ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø±Ø¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ...'\n];\n\nfor (const stage of stages) {\n  console.log(stage);\n  await new Promise(r => setTimeout(r, 450));\n}\n\nconsole.log('âœ… ØªÙ…! Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...');\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ“¤ Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - reply_markup ÙƒÙ€ Object (Ù…Ø´ String!)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nreturn [{\n  json: {\n    text: keyboardData.text,\n    reply_markup: keyboardData.reply_markup,  // â¬…ï¸ Object Ù…Ø¨Ø§Ø´Ø±Ø©! (Ø¨Ø¯ÙˆÙ† stringify)\n    parse_mode: 'HTML',\n    disable_web_page_preview: true\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1936,
        -64
      ],
      "id": "033a18c2-8148-4e89-8ce7-a7203dcb5651",
      "name": "Delay and Pass Data"
    }
  ],
  "pinData": {},
  "connections": {
    "ChatCore": {
      "main": [
        [
          {
            "node": "Format Telegram Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "userInput": {
      "main": [
        [
          {
            "node": "sessionData",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "sessionData": {
      "main": [
        [
          {
            "node": "conversationStore",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "latestContext": {
      "main": [
        [
          {
            "node": "ChatCore",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "memoryRetriever": {
      "ai_memory": [
        [
          {
            "node": "conversationStore",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "conversationStore": {
      "main": [
        [
          {
            "node": "latestContext",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "conversationMemory": {
      "ai_memory": [
        [
          {
            "node": "ChatCore",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Mistral Cloud Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "ChatCore",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "find_book_download_link": {
      "ai_tool": [
        [
          {
            "node": "ChatCore",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Format Telegram Message": {
      "main": [
        [
          {
            "node": "Build Inline Keyboard",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Inline Keyboard": {
      "main": [
        [
          {
            "node": "Delay and Pass Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send a chat action": {
      "main": [
        [
          {
            "node": "sendTextMessage",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delay and Pass Data": {
      "main": [
        [
          {
            "node": "Send a chat action",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "08aa8371-0fd8-4f12-8b85-fb2d096e40b0",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "bd20fadb32275a6435f0552a03c417ec118fbafa62991c11c7a720ebf7724a66"
  },
  "id": "sEeJx76h8FVxpkrq",
  "tags": []
}
